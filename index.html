<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Makler Pro</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Outfit', sans-serif; background-color: #f1f5f9; -webkit-tap-highlight-color: transparent; }
        .glass { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(12px); border-bottom: 1px solid rgba(226, 232, 240, 0.8); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .loader { width: 40px; height: 40px; border: 4px solid #e2e8f0; border-bottom-color: #2563eb; border-radius: 50%; display: inline-block; animation: rotation 1s linear infinite; }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .slider-container { position: relative; width: 100%; aspect-ratio: 4/3; overflow: hidden; background: #000; }
        .slider-track { display: flex; transition: transform 0.5s ease; height: 100%; }
        .slide-item { min-width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; background: #1a1a1a; }
        .slide-item img { max-width: 100%; max-height: 100%; object-fit: contain; }
        
        .slider-btn { position: absolute; top: 50%; transform: translateY(-50%); background: rgba(0,0,0,0.4); color: white; width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; z-index: 10; cursor: pointer; }
        .slider-dots { position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%); display: flex; gap: 5px; z-index: 10; }
        .dot { width: 7px; height: 7px; border-radius: 50%; background: rgba(255,255,255,0.4); }
        .dot.active { background: #fff; width: 15px; border-radius: 10px; }
        
        .modal-enter { animation: modalUp 0.3s ease-out forwards; }
        @keyframes modalUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
        
        .contact-banner { background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); }
        
        .card-phone-link { display: flex; items-center: center; gap: 8px; padding: 10px; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 12px; font-weight: 700; font-size: 13px; color: #1e293b; transition: all 0.2s; }
        .card-phone-link:active { background: #e2e8f0; transform: scale(0.98); }
    </style>
</head>
<body class="text-slate-800 pb-20">

    <nav class="glass sticky top-0 z-50 px-4 py-3 flex justify-between items-center">
        <div class="flex items-center gap-3 cursor-pointer" onclick="location.reload()">
            <div class="bg-blue-600 text-white w-10 h-10 rounded-xl flex items-center justify-center shadow-lg">
                <i class="fa-solid fa-house-chimney text-lg"></i>
            </div>
            <div>
                <h1 class="font-bold text-lg leading-none">Makler<span class="text-blue-600">Pro</span></h1>
                <p class="text-[9px] text-slate-400 font-bold uppercase tracking-wider">Professional Real Estate</p>
            </div>
        </div>
        <div class="flex items-center gap-2">
            <button id="contactMgrBtn" onclick="openContactManager()" class="hidden bg-slate-100 text-slate-600 w-10 h-10 rounded-xl flex items-center justify-center border border-slate-200">
                <i class="fa-solid fa-phone-flip text-sm"></i>
            </button>
            <button id="tgBtn" onclick="openTgManager()" class="hidden bg-blue-50 text-blue-600 w-10 h-10 rounded-xl flex items-center justify-center border border-blue-100">
                <i class="fa-brands fa-telegram text-xl"></i>
            </button>
            <button id="authBtn" onclick="handleAuth()" class="bg-slate-100 text-slate-700 px-4 py-2.5 rounded-xl text-xs font-bold flex items-center gap-2 border border-slate-200">
                <i class="fa-solid fa-user-tie"></i> Admin
            </button>
        </div>
    </nav>

    <!-- CONTACT BANNER -->
    <div id="contactBanner" class="m-4 rounded-[2rem] p-6 contact-banner text-white relative overflow-hidden hidden">
        <div class="relative z-10">
            <h2 id="bannerTitle" class="text-lg font-bold mb-2"></h2>
            <p id="bannerText" class="text-slate-300 text-xs mb-4"></p>
            <div id="bannerPhones" class="flex flex-wrap gap-3"></div>
        </div>
        <i class="fa-solid fa-house-laptop absolute -right-6 -bottom-6 text-8xl text-white/5 rotate-12"></i>
    </div>

    <!-- FILTERS -->
    <div class="bg-white border-b sticky top-[65px] z-40 py-3 px-4 overflow-x-auto no-scrollbar">
        <div class="flex gap-2 min-w-max">
            <button onclick="filterItems('all', this)" class="filter-btn active bg-blue-600 text-white px-5 py-2 rounded-xl text-xs font-bold shadow-md shadow-blue-200">Barchasi</button>
            <button onclick="filterItems('sotuv', this)" class="filter-btn bg-white border border-slate-200 px-5 py-2 rounded-xl text-xs font-bold">Sotuv</button>
            <button onclick="filterItems('ijara', this)" class="filter-btn bg-white border border-slate-200 px-5 py-2 rounded-xl text-xs font-bold">Ijara</button>
        </div>
    </div>

    <main class="max-w-7xl mx-auto p-4 min-h-screen">
        <div id="loaderView" class="flex flex-col items-center justify-center py-32">
            <span class="loader mb-4"></span>
            <p class="text-slate-400 text-sm font-medium">Yuklanmoqda...</p>
        </div>
        <div id="emptyView" class="hidden text-center py-20">
            <i class="fa-solid fa-folder-open text-slate-200 text-5xl mb-4"></i>
            <p class="text-slate-400">Hech qanday ma'lumot topilmadi</p>
        </div>
        <div id="listingGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-5"></div>
    </main>

    <button id="fabBtn" onclick="openAddModal()" class="hidden fixed bottom-6 right-6 z-50 bg-blue-600 text-white w-14 h-14 rounded-2xl shadow-2xl flex items-center justify-center">
        <i class="fa-solid fa-plus text-2xl"></i>
    </button>

    <!-- MODAL: ADD/EDIT -->
    <div id="propModal" class="fixed inset-0 z-[100] bg-slate-900/70 backdrop-blur-sm hidden flex items-end sm:items-center justify-center sm:p-4">
        <div class="bg-white w-full sm:max-w-lg max-h-[92vh] overflow-y-auto rounded-t-[2.5rem] sm:rounded-3xl p-6 modal-enter no-scrollbar">
            <div class="flex justify-between items-center mb-6">
                <h3 id="modalTitle" class="text-xl font-extrabold text-slate-800">Yangi E'lon</h3>
                <button onclick="closeModal('propModal')" class="w-8 h-8 flex items-center justify-center bg-slate-100 rounded-full text-slate-400"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <input type="hidden" id="editId">
            <div class="space-y-4">
                <div class="grid grid-cols-2 gap-3">
                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Tur</label>
                        <select id="propType" class="w-full p-3.5 bg-slate-50 border border-slate-200 rounded-2xl text-sm font-semibold outline-none focus:border-blue-500">
                            <option value="sotuv">Sotuv</option>
                            <option value="ijara">Ijara</option>
                        </select>
                    </div>
                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Kategoriya</label>
                        <select id="propCat" class="w-full p-3.5 bg-slate-50 border border-slate-200 rounded-2xl text-sm font-semibold outline-none focus:border-blue-500">
                            <option value="dom">Dom</option>
                            <option value="hovli">Hovli</option>
                        </select>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Narxi ($)</label>
                        <input type="number" id="propPrice" class="w-full p-3.5 bg-slate-50 border border-slate-200 rounded-2xl text-sm font-semibold outline-none focus:border-blue-500">
                    </div>
                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Xonalar</label>
                        <input type="number" id="propRooms" class="w-full p-3.5 bg-slate-50 border border-slate-200 rounded-2xl text-sm font-semibold outline-none focus:border-blue-500">
                    </div>
                </div>
                <div class="space-y-1">
                    <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Tavsif</label>
                    <textarea id="propDesc" rows="3" class="w-full p-3.5 bg-slate-50 border border-slate-200 rounded-2xl text-sm font-semibold outline-none focus:border-blue-500"></textarea>
                </div>
                
                <div class="border-2 border-dashed border-slate-200 rounded-2xl p-6 text-center cursor-pointer" onclick="document.getElementById('fileInp').click()">
                    <input type="file" id="fileInp" class="hidden" accept="image/*" multiple onchange="handleFiles(event)">
                    <div class="text-blue-600 mb-1"><i class="fa-solid fa-cloud-arrow-up text-3xl"></i></div>
                    <p class="text-xs font-bold text-slate-500">Rasmlarni yuklang (Maks. 10ta)</p>
                </div>
                <div id="imgPreviewList" class="grid grid-cols-4 gap-2"></div>
                
                <button onclick="saveItem()" id="saveBtn" class="w-full bg-blue-600 text-white font-bold py-4 rounded-2xl shadow-lg active:scale-95 transition-transform">E'LONNI SAQLASH</button>
            </div>
        </div>
    </div>

    <!-- MODAL: CONTACTS -->
    <div id="contactModal" class="fixed inset-0 z-[110] bg-slate-900/70 backdrop-blur-sm hidden flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-md rounded-[2rem] p-6 modal-enter overflow-y-auto max-h-[90vh]">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-lg font-extrabold">Banner va Kontaktlar</h2>
                <button onclick="closeModal('contactModal')" class="w-8 h-8 flex items-center justify-center bg-slate-100 rounded-full text-slate-400"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="space-y-4">
                <div class="space-y-1">
                    <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Sarlavha</label>
                    <input type="text" id="mgrBannerTitle" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-sm font-semibold outline-none">
                </div>
                <div class="space-y-1">
                    <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Matn</label>
                    <textarea id="mgrBannerText" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-sm font-semibold outline-none" rows="2"></textarea>
                </div>
                <div class="border-t pt-4">
                    <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Admin Telefonlari</label>
                    <div class="flex gap-2 mt-1">
                        <input type="text" id="newContactPhone" placeholder="+998..." class="flex-1 p-3 bg-slate-50 border border-slate-200 rounded-xl text-sm font-semibold outline-none">
                        <button onclick="addContactPhone()" class="bg-blue-600 text-white px-4 rounded-xl font-bold"><i class="fa-solid fa-plus"></i></button>
                    </div>
                </div>
                <div id="mgrPhoneList" class="space-y-2 mt-2"></div>
                <button onclick="saveBannerSettings()" id="saveBannerBtn" class="w-full bg-blue-600 text-white font-bold py-3.5 rounded-xl shadow-lg">SAQLASH</button>
            </div>
        </div>
    </div>

    <!-- MODAL: TELEGRAM -->
    <div id="tgModal" class="fixed inset-0 z-[110] bg-slate-900/70 backdrop-blur-sm hidden flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-md rounded-[2rem] p-6 modal-enter">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-extrabold">Telegram Kanallar</h2>
                <button onclick="closeModal('tgModal')" class="w-8 h-8 flex items-center justify-center bg-slate-100 rounded-full text-slate-400"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="flex gap-2 mb-4">
                <input type="text" id="newTgTarget" placeholder="@username yoki ID" class="flex-1 p-3.5 bg-slate-50 border border-slate-200 rounded-xl text-sm font-medium outline-none">
                <button onclick="addTarget()" class="bg-blue-600 text-white px-5 rounded-xl font-bold"><i class="fa-solid fa-plus"></i></button>
            </div>
            <div id="targetList" class="max-h-60 overflow-y-auto space-y-2 mb-4"></div>
            <button onclick="closeModal('tgModal')" class="w-full bg-slate-100 py-3.5 rounded-xl font-bold text-slate-600">Yopish</button>
        </div>
    </div>

    <!-- AUTH -->
    <div id="authModal" class="fixed inset-0 z-[120] bg-slate-900/60 hidden flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-xs rounded-3xl p-6 modal-enter text-center">
            <div class="w-16 h-16 bg-blue-50 text-blue-600 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fa-solid fa-shield-halved text-2xl"></i>
            </div>
            <h2 class="text-xl font-bold mb-2">Admin Tizimi</h2>
            <input type="password" id="adminPass" placeholder="Parol" class="w-full p-3.5 bg-slate-50 border border-slate-200 rounded-xl mb-4 text-center font-bold tracking-widest">
            <button onclick="doLogin()" class="w-full bg-slate-900 text-white py-3.5 rounded-xl font-bold">KIRISH</button>
        </div>
    </div>

    <div id="toast" class="fixed bottom-10 left-1/2 -translate-x-1/2 bg-slate-800 text-white px-6 py-3 rounded-2xl shadow-2xl z-[200] opacity-0 transition-all pointer-events-none text-sm font-bold flex items-center gap-2">
        <i class="fa-solid fa-circle-info text-blue-400"></i>
        <span id="toastMsg"></span>
    </div>

    <script>
        const SB_URL = 'https://bdnvuqusiualwgyhqvbq.supabase.co';
        const SB_KEY = 'sb_publishable_7kl3oNQ7tmJQ9qOsEgWoSg_pL4-D7k_';
        const TG_TOKEN = '8351044776:AAHpT3rEti6mxSmNXzQiDuRaGCWhWcOfa0Q';
        const sb = window.supabase.createClient(SB_URL, SB_KEY);

        let isAdmin = false, properties = [], currentImages = [], tgTargets = [], bannerData = { title: '', text: '', phones: [] };

        document.addEventListener('DOMContentLoaded', () => { 
            if(localStorage.getItem('makler_admin') === 'true') { isAdmin = true; updateUI(); }
            fetchData();
            fetchBannerData();
            fetchTgTargets();
        });

        async function fetchData() {
            try {
                const { data, error } = await sb.from('properties').select('*').order('created_at', { ascending: false });
                if (error) throw error;
                properties = data || [];
                renderList(properties);
            } catch (err) { showToast("Bazaga ulanishda xatolik!"); }
            finally { document.getElementById('loaderView').classList.add('hidden'); }
        }

        async function fetchBannerData() {
            try {
                const { data } = await sb.from('settings').select('*').eq('key', 'contact_banner').single();
                if (data) { bannerData = data.value; renderBanner(); renderList(properties); }
            } catch (err) {}
        }

        async function fetchTgTargets() {
            try {
                const { data, error } = await sb.from('telegram_targets').select('*');
                if(error) throw error;
                tgTargets = data || [];
                renderTargetList();
            } catch (err) { console.error("Targets fetch error:", err); }
        }

        function renderBanner() {
            const banner = document.getElementById('contactBanner');
            if (!bannerData || (!bannerData.title && !bannerData.phones?.length)) { banner.classList.add('hidden'); return; }
            banner.classList.remove('hidden');
            document.getElementById('bannerTitle').innerText = bannerData.title || "Biz bilan bog'laning";
            document.getElementById('bannerText').innerText = bannerData.text || "";
            const container = document.getElementById('bannerPhones');
            container.innerHTML = (bannerData.phones || []).map(p => `
                <a href="tel:${p}" class="bg-white/10 px-4 py-2 rounded-xl border border-white/20 flex items-center gap-2">
                    <i class="fa-solid fa-phone text-[10px] text-blue-300"></i>
                    <span class="text-sm font-bold">${p}</span>
                </a>
            `).join('');
        }

        function renderList(list) {
            const grid = document.getElementById('listingGrid');
            grid.innerHTML = '';
            if(!list.length) { document.getElementById('emptyView').classList.remove('hidden'); return; }
            document.getElementById('emptyView').classList.add('hidden');

            list.forEach(item => {
                const imgs = (item.images_array && item.images_array.length > 0) ? item.images_array : (item.image_data ? [item.image_data] : []);
                const card = document.createElement('div');
                card.className = "bg-white rounded-[2rem] overflow-hidden border border-slate-100 flex flex-col relative shadow-sm hover:shadow-xl transition-all";
                
                let adminControls = isAdmin ? `
                    <div class="absolute top-4 right-4 flex gap-2 z-20">
                        <button onclick="editItem(${item.id})" class="w-9 h-9 bg-white text-blue-600 rounded-xl flex items-center justify-center shadow-lg"><i class="fa-solid fa-pen-to-square text-sm"></i></button>
                        <button onclick="sendToMultiTelegram(${item.id})" class="w-9 h-9 bg-blue-600 text-white rounded-xl flex items-center justify-center shadow-lg"><i class="fa-brands fa-telegram text-lg"></i></button>
                        <button onclick="deleteItem(${item.id})" class="w-9 h-9 bg-red-500 text-white rounded-xl flex items-center justify-center shadow-lg"><i class="fa-solid fa-trash-can text-sm"></i></button>
                    </div>
                ` : '';

                const phonesHtml = (bannerData.phones || []).map(p => `
                    <a href="tel:${p}" class="card-phone-link"><i class="fa-solid fa-phone text-blue-500"></i> ${p}</a>
                `).join('');

                card.innerHTML = `
                    <div class="slider-container">
                        <div class="slider-track" id="track-${item.id}" data-index="0">
                            ${imgs.length > 0 ? imgs.map(img => `<div class="slide-item"><img src="${img}"></div>`).join('') : '<div class="slide-item text-slate-500">Rasm yo\'q</div>'}
                        </div>
                        ${imgs.length > 1 ? `
                            <button onclick="moveSlider(${item.id}, -1)" class="slider-btn left-2"><i class="fa-solid fa-chevron-left"></i></button>
                            <button onclick="moveSlider(${item.id}, 1)" class="slider-btn right-2"><i class="fa-solid fa-chevron-right"></i></button>
                            <div class="slider-dots" id="dots-${item.id}">${imgs.map((_, i) => `<div class="dot ${i===0?'active':''}"></div>`).join('')}</div>
                        ` : ''}
                        <div class="absolute top-4 left-4 bg-blue-600 text-white px-4 py-1.5 rounded-xl text-[10px] font-black uppercase z-10">${item.type}</div>
                        ${adminControls}
                    </div>
                    <div class="p-6 flex flex-col flex-1">
                        <h3 class="text-2xl font-black text-slate-800 mb-2">$${Number(item.price).toLocaleString()}</h3>
                        <p class="text-slate-500 text-sm font-medium mb-3 flex items-center gap-2">
                           <i class="fa-solid fa-door-open text-blue-500"></i> ${item.rooms} xona (${item.category})
                        </p>
                        <p class="text-slate-400 text-xs line-clamp-2 mb-4 italic">${item.description || 'Tavsif yo\'q'}</p>
                        <div class="mt-auto space-y-2">
                            <p class="text-[10px] font-bold text-slate-400 uppercase">Aloqa:</p>
                            <div class="grid grid-cols-1 gap-2">${phonesHtml}</div>
                        </div>
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        function moveSlider(propId, dir) {
            const track = document.getElementById(`track-${propId}`);
            const dots = document.querySelectorAll(`#dots-${propId} .dot`);
            if(!track || !dots.length) return;
            const total = track.children.length;
            let current = parseInt(track.dataset.index || 0);
            current = (current + dir + total) % total;
            track.style.transform = `translateX(-${current * 100}%)`;
            track.dataset.index = current;
            dots.forEach((dot, i) => i === current ? dot.classList.add('active') : dot.classList.remove('active'));
        }

        async function saveItem() {
            if(!currentImages.length) return showToast("Rasm yuklang!");
            const id = document.getElementById('editId').value;
            const btn = document.getElementById('saveBtn');
            btn.disabled = true; btn.innerText = "SAQLANMOQDA...";

            const payload = {
                type: document.getElementById('propType').value,
                category: document.getElementById('propCat').value,
                price: document.getElementById('propPrice').value,
                rooms: document.getElementById('propRooms').value,
                description: document.getElementById('propDesc').value,
                image_data: currentImages[0],
                images_array: currentImages 
            };

            try {
                const res = id ? await sb.from('properties').update(payload).eq('id', id) : await sb.from('properties').insert([payload]);
                if (res.error) throw res.error;
                showToast("Muvaffaqiyatli saqlandi!");
                closeModal('propModal');
                fetchData();
            } catch (err) { showToast("Xatolik!"); }
            finally { btn.disabled = false; btn.innerText = "E'LONNI SAQLASH"; }
        }

        async function sendToMultiTelegram(id) {
            const item = properties.find(p => p.id === id);
            const imgs = (item.images_array && item.images_array.length > 0) ? item.images_array : (item.image_data ? [item.image_data] : []);
            
            const phones = (bannerData.phones || []).join(', ');
            const caption = `üè† *E'lon:* ${item.category.toUpperCase()}\nüí∞ *Narxi:* $${Number(item.price).toLocaleString()}\nüìç *Turi:* ${item.type.toUpperCase()}\nüö™ *Xonalar:* ${item.rooms}\nüìû *Aloqa:* ${phones || 'Admin bilan bog\'laning'}\n\nüí¨ *Tavsif:* ${item.description || 'Mavjud emas'}`;

            if(!tgTargets.length) {
                const { data } = await sb.from('telegram_targets').select('*');
                tgTargets = data || [];
            }
            if(!tgTargets.length) return showToast("Kanallar belgilanmagan!");

            showToast("Yuborilmoqda...");
            
            for (const t of tgTargets) {
                try {
                    if (imgs.length === 0) {
                        await fetch(`https://api.telegram.org/bot${TG_TOKEN}/sendMessage`, { 
                            method: 'POST', headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ chat_id: t.target_id, text: caption, parse_mode: 'Markdown' })
                        });
                    } else if (imgs.length === 1) {
                        const blob = await (await fetch(imgs[0])).blob();
                        const fd = new FormData();
                        fd.append('chat_id', t.target_id);
                        fd.append('photo', blob, 'img.jpg');
                        fd.append('caption', caption);
                        fd.append('parse_mode', 'Markdown');
                        await fetch(`https://api.telegram.org/bot${TG_TOKEN}/sendPhoto`, { method: 'POST', body: fd });
                    } else {
                        const mediaFD = new FormData();
                        mediaFD.append('chat_id', t.target_id);
                        const mediaArr = [];
                        for(let i=0; i < Math.min(imgs.length, 10); i++) {
                            const blob = await (await fetch(imgs[i])).blob();
                            mediaFD.append(`f${i}`, blob, `f${i}.jpg`);
                            mediaArr.push({ type: 'photo', media: `attach://f${i}`, caption: i === 0 ? caption : '', parse_mode: 'Markdown' });
                        }
                        mediaFD.append('media', JSON.stringify(mediaArr));
                        await fetch(`https://api.telegram.org/bot${TG_TOKEN}/sendMediaGroup`, { method: 'POST', body: mediaFD });
                    }
                } catch(e) { console.error("TG error:", e); }
            }
            showToast("Telegramga yuborildi!");
        }

        function handleFiles(e) {
            const files = Array.from(e.target.files).slice(0, 10);
            files.forEach(file => {
                const reader = new FileReader();
                reader.onload = (ev) => { currentImages.push(ev.target.result); renderImagePreviews(); };
                reader.readAsDataURL(file);
            });
        }
        function renderImagePreviews() {
            const list = document.getElementById('imgPreviewList');
            list.innerHTML = currentImages.map((img, idx) => `
                <div class="relative aspect-square rounded-xl overflow-hidden border border-slate-200">
                    <img src="${img}" class="w-full h-full object-cover">
                    <button onclick="removeImg(${idx})" class="absolute top-1 right-1 bg-red-500 text-white w-5 h-5 rounded-full text-[10px] flex items-center justify-center">√ó</button>
                </div>
            `).join('');
        }
        function removeImg(idx) { currentImages.splice(idx, 1); renderImagePreviews(); }
        function openModal(id) { document.getElementById(id).classList.remove('hidden'); }
        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
        function showToast(msg) {
            const t = document.getElementById('toast');
            document.getElementById('toastMsg').innerText = msg;
            t.style.opacity = '1'; setTimeout(() => t.style.opacity = '0', 3000);
        }
        function handleAuth() {
            if(isAdmin) { if(confirm("Chiqasizmi?")) { localStorage.removeItem('makler_admin'); location.reload(); } }
            else openModal('authModal');
        }
        function doLogin() {
            if(document.getElementById('adminPass').value === '123') {
                localStorage.setItem('makler_admin', 'true'); location.reload();
            } else showToast("Parol xato!");
        }
        function updateUI() {
            document.getElementById('authBtn').innerHTML = '<i class="fa-solid fa-user-gear"></i> Chiqish';
            document.getElementById('fabBtn').classList.remove('hidden');
            document.getElementById('tgBtn').classList.remove('hidden');
            document.getElementById('contactMgrBtn').classList.remove('hidden');
        }
        function openAddModal() { document.getElementById('editId').value = ""; currentImages = []; renderImagePreviews(); openModal('propModal'); }
        function editItem(id) {
            const item = properties.find(p => p.id === id);
            document.getElementById('editId').value = item.id;
            document.getElementById('propType').value = item.type;
            document.getElementById('propCat').value = item.category;
            document.getElementById('propPrice').value = item.price;
            document.getElementById('propRooms').value = item.rooms;
            document.getElementById('propDesc').value = item.description;
            currentImages = item.images_array || [item.image_data];
            renderImagePreviews(); openModal('propModal');
        }
        async function deleteItem(id) { if(confirm("O'chirilsinmi?")) { await sb.from('properties').delete().eq('id', id); fetchData(); } }
        function filterItems(type, btn) {
            document.querySelectorAll('.filter-btn').forEach(b => b.className = "filter-btn bg-white border border-slate-200 px-5 py-2 rounded-xl text-xs font-bold");
            btn.className = "filter-btn active bg-blue-600 text-white px-5 py-2 rounded-xl text-xs font-bold shadow-md shadow-blue-200";
            renderList(type === 'all' ? properties : properties.filter(p => p.type === type));
        }

        function openContactManager() {
            document.getElementById('mgrBannerTitle').value = bannerData.title || "";
            document.getElementById('mgrBannerText').value = bannerData.text || "";
            renderMgrPhoneList(); openModal('contactModal');
        }
        function renderMgrPhoneList() {
            document.getElementById('mgrPhoneList').innerHTML = (bannerData.phones || []).map((p, idx) => `
                <div class="flex items-center justify-between p-3 bg-slate-50 border rounded-xl">
                    <span class="text-sm font-bold">${p}</span>
                    <button onclick="removeContactPhone(${idx})" class="text-red-500"><i class="fa-solid fa-trash-can"></i></button>
                </div>
            `).join('');
        }
        function addContactPhone() {
            const val = document.getElementById('newContactPhone').value.trim();
            if(val) { bannerData.phones = bannerData.phones || []; bannerData.phones.push(val); document.getElementById('newContactPhone').value = ""; renderMgrPhoneList(); }
        }
        function removeContactPhone(idx) { bannerData.phones.splice(idx, 1); renderMgrPhoneList(); }
        async function saveBannerSettings() {
            bannerData.title = document.getElementById('mgrBannerTitle').value;
            bannerData.text = document.getElementById('mgrBannerText').value;
            await sb.from('settings').upsert({ key: 'contact_banner', value: bannerData });
            renderBanner(); renderList(properties); closeModal('contactModal');
        }

        // Telegram Manager
        function openTgManager() {
            fetchTgTargets();
            openModal('tgModal');
        }
        function renderTargetList() {
            document.getElementById('targetList').innerHTML = tgTargets.map(t => `
                <div class="flex items-center justify-between p-3 bg-slate-50 border rounded-xl">
                    <span class="text-sm font-bold">${t.target_id}</span>
                    <button onclick="removeTarget(${t.id})" class="text-red-500 hover:text-red-700 p-2"><i class="fa-solid fa-trash-can"></i></button>
                </div>
            `).join('');
        }
        async function addTarget() {
            const val = document.getElementById('newTgTarget').value.trim();
            if(!val) return;
            try {
                const { data, error } = await sb.from('telegram_targets').insert([{ target_id: val }]).select();
                if(error) throw error;
                document.getElementById('newTgTarget').value = '';
                await fetchTgTargets(); // Listni yangilash
                showToast("Kanal qo'shildi");
            } catch (err) { 
                showToast("Xatolik! Balki bu kanal allaqachon bor?");
                console.error(err);
            }
        }
        async function removeTarget(id) {
            try {
                const { error } = await sb.from('telegram_targets').delete().eq('id', id);
                if(error) throw error;
                await fetchTgTargets(); // Listni yangilash
                showToast("Kanal o'chirildi");
            } catch (err) { 
                showToast("O'chirishda xatolik");
                console.error(err);
            }
        }
    </script>
</body>
</html>