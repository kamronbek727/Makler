<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Makler Pro</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Outfit', sans-serif; background-color: #f1f5f9; -webkit-tap-highlight-color: transparent; }
        .glass { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(12px); border-bottom: 1px solid rgba(226, 232, 240, 0.8); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .loader { width: 40px; height: 40px; border: 4px solid #e2e8f0; border-bottom-color: #2563eb; border-radius: 50%; display: inline-block; animation: rotation 1s linear infinite; }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* SLAYDER VA RASM DIZAYNI O'ZGARTIRILDI */
        .slider-container { position: relative; width: 100%; aspect-ratio: 1/1; overflow: hidden; background: #e2e8f0; }
        @media (min-width: 640px) { .slider-container { aspect-ratio: 4/3; } }

        .slider-track { display: flex; transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1); height: 100%; }
        /* Rasm markazda va to'liq ko'rinadi (contain) */
        .slide-item { min-width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; background-color: #000000; }
        .slide-item img { width: 100%; height: 100%; object-fit: contain; } 
        
        .slider-btn { position: absolute; top: 50%; transform: translateY(-50%); background: rgba(0,0,0,0.5); color: white; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; z-index: 10; cursor: pointer; backdrop-filter: blur(4px); }
        .slider-dots { position: absolute; bottom: 8px; left: 50%; transform: translateX(-50%); display: flex; gap: 4px; z-index: 10; }
        .dot { width: 5px; height: 5px; border-radius: 50%; background: rgba(255,255,255,0.5); transition: all 0.3s; }
        .dot.active { background: #fff; width: 10px; border-radius: 10px; }
        
        .modal-enter { animation: modalUp 0.25s ease-out forwards; }
        @keyframes modalUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        
        .contact-banner { background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); }
        .card-phone-link { display: flex; align-items: center; justify-content: center; gap: 6px; padding: 8px; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 10px; font-weight: 700; font-size: 11px; color: #1e293b; white-space: nowrap; }
        .select-checkbox { transform: scale(1.2); cursor: pointer; }
    </style>
</head>
<body class="text-slate-800 pb-20">

    <nav class="glass sticky top-0 z-50 px-4 py-3 flex justify-between items-center">
        <div class="flex items-center gap-2 cursor-pointer" onclick="location.reload()">
            <div class="bg-blue-600 text-white w-8 h-8 rounded-lg flex items-center justify-center shadow-lg">
                <i class="fa-solid fa-house-chimney text-sm"></i>
            </div>
            <div>
                <h1 class="font-bold text-base leading-none">Makler<span class="text-blue-600">Pro</span></h1>
            </div>
        </div>
        <div class="flex items-center gap-2">
            <button id="contactMgrBtn" onclick="openContactManager()" class="hidden bg-slate-100 text-slate-600 w-9 h-9 rounded-lg flex items-center justify-center border border-slate-200">
                <i class="fa-solid fa-phone-flip text-xs"></i>
            </button>
            <button id="tgBtn" onclick="openTgManager()" class="hidden bg-blue-50 text-blue-600 w-9 h-9 rounded-lg flex items-center justify-center border border-blue-100">
                <i class="fa-brands fa-telegram text-lg"></i>
            </button>
            <button id="authBtn" onclick="handleAuth()" class="bg-slate-100 text-slate-700 px-3 py-2 rounded-lg text-xs font-bold flex items-center gap-1 border border-slate-200">
                <i class="fa-solid fa-user-tie"></i> Admin
            </button>
        </div>
    </nav>

    <div id="adminToolbar" class="hidden bg-blue-50 border-b p-3 px-4 flex justify-between items-center sticky top-[60px] z-50">
        <div class="flex items-center gap-2">
            <input type="checkbox" id="selectAll" onchange="toggleSelectAll()" class="select-checkbox">
            <span class="text-xs font-bold text-blue-800">Barchasi</span>
        </div>
        <button onclick="sendSelectedToTg()" class="bg-blue-600 text-white px-3 py-1.5 rounded-lg text-xs font-bold flex items-center gap-1 active:scale-95 transition-transform">
            <i class="fa-brands fa-telegram"></i> Yuborish
        </button>
    </div>

    <div id="contactBanner" class="mx-3 my-3 rounded-2xl p-5 contact-banner text-white relative overflow-hidden hidden">
        <div class="relative z-10">
            <h2 id="bannerTitle" class="text-base font-bold mb-1"></h2>
            <p id="bannerText" class="text-slate-300 text-xs mb-3"></p>
            <div id="bannerPhones" class="flex flex-wrap gap-2"></div>
        </div>
        <i class="fa-solid fa-house-laptop absolute -right-4 -bottom-4 text-7xl text-white/5 rotate-12"></i>
    </div>

    <div class="bg-white border-b sticky top-[60px] z-40 py-2 px-3 overflow-x-auto no-scrollbar" id="filterBar">
        <div class="flex gap-2 min-w-max">
            <button onclick="filterItems('all', this)" class="filter-btn active bg-blue-600 text-white px-4 py-1.5 rounded-lg text-xs font-bold shadow-sm">Barchasi</button>
            <button onclick="filterItems('sotuv', this)" class="filter-btn bg-white border border-slate-200 px-4 py-1.5 rounded-lg text-xs font-bold">Sotuv</button>
            <button onclick="filterItems('ijara', this)" class="filter-btn bg-white border border-slate-200 px-4 py-1.5 rounded-lg text-xs font-bold">Ijara</button>
        </div>
    </div>

    <main class="max-w-7xl mx-auto p-3 min-h-screen">
        <div id="loaderView" class="flex flex-col items-center justify-center py-32">
            <span class="loader mb-4"></span>
            <p class="text-slate-400 text-xs font-medium">Yuklanmoqda...</p>
        </div>
        <div id="emptyView" class="hidden text-center py-20">
            <i class="fa-solid fa-folder-open text-slate-200 text-4xl mb-3"></i>
            <p class="text-slate-400 text-sm">Hozircha e'lonlar yo'q</p>
        </div>
        
        <div id="listingGrid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3"></div>
    </main>

    <button id="fabBtn" onclick="openAddModal()" class="hidden fixed bottom-6 right-6 z-50 bg-blue-600 text-white w-12 h-12 rounded-2xl shadow-xl flex items-center justify-center active:scale-90 transition-transform">
        <i class="fa-solid fa-plus text-xl"></i>
    </button>

    <!-- MODAL: ADD/EDIT -->
    <div id="propModal" class="fixed inset-0 z-[100] bg-slate-900/70 backdrop-blur-sm hidden flex items-end sm:items-center justify-center sm:p-4">
        <div class="bg-white w-full sm:max-w-lg max-h-[95vh] overflow-y-auto rounded-t-3xl sm:rounded-3xl p-5 modal-enter no-scrollbar">
            <div class="flex justify-between items-center mb-5">
                <h3 id="modalTitle" class="text-lg font-bold text-slate-800">Yangi E'lon</h3>
                <button onclick="closeModal('propModal')" class="w-8 h-8 flex items-center justify-center bg-slate-100 rounded-full text-slate-400"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <input type="hidden" id="editId">
            <div class="space-y-3">
                <div class="grid grid-cols-2 gap-3">
                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Tur</label>
                        <select id="propType" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-sm font-semibold">
                            <option value="sotuv">Sotuv</option>
                            <option value="ijara">Ijara</option>
                        </select>
                    </div>
                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Kategoriya</label>
                        <select id="propCat" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-sm font-semibold">
                            <option value="dom">Dom</option>
                            <option value="hovli">Hovli</option>
                        </select>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Narxi ($)</label>
                        <input type="number" id="propPrice" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-sm font-semibold">
                    </div>
                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Xonalar</label>
                        <input type="number" id="propRooms" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-sm font-semibold">
                    </div>
                </div>
                <div class="space-y-1">
                    <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Uy Egasi (Faqat sizga)</label>
                    <input type="text" id="propOwnerPhone" placeholder="+998..." class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-sm font-semibold">
                </div>
                <div class="space-y-1">
                    <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Tavsif</label>
                    <textarea id="propDesc" rows="3" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-sm font-semibold"></textarea>
                </div>
                
                <div id="uploadArea" class="border-2 border-dashed border-slate-200 rounded-xl p-4 text-center cursor-pointer hover:border-blue-400 transition-colors" onclick="document.getElementById('fileInp').click()">
                    <input type="file" id="fileInp" class="hidden" accept="image/*" multiple onchange="handleFiles(event)">
                    <div class="text-blue-600 mb-1"><i class="fa-solid fa-images text-2xl"></i></div>
                    <p class="text-xs font-bold text-slate-500">Rasmlarni tanlang (Maks. 10ta)</p>
                </div>
                <div id="imgPreviewList" class="grid grid-cols-4 gap-2"></div>
                
                <button onclick="saveItem()" id="saveBtn" class="w-full bg-blue-600 text-white font-bold py-3.5 rounded-xl shadow-lg active:scale-95 transition-transform flex items-center justify-center gap-2 text-sm">
                   <span id="saveBtnText">SAQLASH</span>
                </button>
            </div>
        </div>
    </div>

    <!-- MODAL: CONTACTS -->
    <div id="contactModal" class="fixed inset-0 z-[110] bg-slate-900/70 backdrop-blur-sm hidden flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-md rounded-2xl p-5 modal-enter overflow-y-auto max-h-[90vh]">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-extrabold">Kontakt Sozlamalari</h2>
                <button onclick="closeModal('contactModal')" class="w-8 h-8 flex items-center justify-center bg-slate-100 rounded-full text-slate-400"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="space-y-3">
                <input type="text" id="mgrBannerTitle" placeholder="Sarlavha" class="w-full p-3 bg-slate-50 border rounded-xl text-sm font-semibold">
                <textarea id="mgrBannerText" placeholder="Matn" class="w-full p-3 bg-slate-50 border rounded-xl text-sm font-semibold" rows="2"></textarea>
                <div class="border-t pt-3">
                    <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Telefonlar</label>
                    <div class="flex gap-2 mt-1">
                        <input type="text" id="newContactPhone" placeholder="+998..." class="flex-1 p-3 bg-slate-50 border rounded-xl text-sm font-semibold">
                        <button onclick="addContactPhone()" class="bg-blue-600 text-white px-4 rounded-xl font-bold"><i class="fa-solid fa-plus"></i></button>
                    </div>
                </div>
                <div id="mgrPhoneList" class="space-y-2 mt-1"></div>
                <button onclick="saveBannerSettings()" class="w-full bg-blue-600 text-white font-bold py-3 rounded-xl shadow-lg mt-2 text-sm">SAQLASH</button>
            </div>
        </div>
    </div>

    <!-- MODAL: TELEGRAM -->
    <div id="tgModal" class="fixed inset-0 z-[110] bg-slate-900/70 backdrop-blur-sm hidden flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-md rounded-2xl p-5 modal-enter">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-extrabold">Telegram Kanallar</h2>
                <button onclick="closeModal('tgModal')" class="w-8 h-8 flex items-center justify-center bg-slate-100 rounded-full text-slate-400"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="flex gap-2 mb-4">
                <input type="text" id="newTgTarget" placeholder="@username yoki ID" class="flex-1 p-3.5 bg-slate-50 border border-slate-200 rounded-xl text-sm font-medium outline-none">
                <button onclick="addTarget()" class="bg-blue-600 text-white px-4 rounded-xl font-bold"><i class="fa-solid fa-plus"></i></button>
            </div>
            <div id="targetList" class="max-h-52 overflow-y-auto space-y-2 mb-2 no-scrollbar"></div>
        </div>
    </div>

    <!-- AUTH -->
    <div id="authModal" class="fixed inset-0 z-[120] bg-slate-900/60 hidden flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-xs rounded-2xl p-6 modal-enter text-center">
            <div class="w-14 h-14 bg-blue-50 text-blue-600 rounded-full flex items-center justify-center mx-auto mb-3">
                <i class="fa-solid fa-shield-halved text-xl"></i>
            </div>
            <h2 class="text-lg font-bold mb-2">Admin Kirish</h2>
            <input type="password" id="adminPass" placeholder="Parol" class="w-full p-3 bg-slate-50 border rounded-xl mb-4 text-center font-bold tracking-widest outline-none focus:border-blue-500">
            <button onclick="doLogin()" class="w-full bg-slate-900 text-white py-3 rounded-xl font-bold text-sm">KIRISH</button>
        </div>
    </div>

    <div id="toast" class="fixed bottom-10 left-1/2 -translate-x-1/2 bg-slate-800 text-white px-5 py-2.5 rounded-xl shadow-2xl z-[200] opacity-0 transition-all pointer-events-none text-xs font-bold flex items-center gap-2">
        <i class="fa-solid fa-circle-check text-blue-400"></i>
        <span id="toastMsg"></span>
    </div>

    <script>
        const SB_URL = 'https://bdnvuqusiualwgyhqvbq.supabase.co';
        const SB_KEY = 'sb_publishable_7kl3oNQ7tmJQ9qOsEgWoSg_pL4-D7k_';
        const TG_TOKEN = '8351044776:AAHpT3rEti6mxSmNXzQiDuRaGCWhWcOfa0Q';
        const sb = window.supabase.createClient(SB_URL, SB_KEY);

        let isAdmin = false, properties = [], currentImages = [], tgTargets = [], bannerData = { title: '', text: '', phones: [] };
        let selectedIds = new Set();

        document.addEventListener('DOMContentLoaded', () => { 
            if(localStorage.getItem('makler_admin') === 'true') { isAdmin = true; updateUI(); }
            fetchData();
            fetchBannerData();
            fetchTgTargets();
        });

        async function fetchData() {
            try {
                const { data, error } = await sb.from('properties').select('*').order('created_at', { ascending: false });
                if (error) throw error;
                properties = data || [];
                renderList(properties);
            } catch (err) { showToast("Baza bilan bog'lanishda xatolik!"); }
            finally { document.getElementById('loaderView').classList.add('hidden'); }
        }

        async function fetchBannerData() {
            try {
                const { data } = await sb.from('settings').select('*').eq('key', 'contact_banner').single();
                if (data) { bannerData = data.value; renderBanner(); renderList(properties); }
            } catch (err) {}
        }

        async function fetchTgTargets() {
            try {
                const { data } = await sb.from('telegram_targets').select('*');
                tgTargets = data || [];
                renderTargetList();
            } catch (err) {}
        }

        function renderBanner() {
            const banner = document.getElementById('contactBanner');
            if (!bannerData || (!bannerData.title && (!bannerData.phones || bannerData.phones.length === 0))) { banner.classList.add('hidden'); return; }
            banner.classList.remove('hidden');
            document.getElementById('bannerTitle').innerText = bannerData.title || "Biz bilan bog'lanish";
            document.getElementById('bannerText').innerText = bannerData.text || "";
            const container = document.getElementById('bannerPhones');
            container.innerHTML = (bannerData.phones || []).map(p => `
                <a href="tel:${p}" class="bg-white/10 px-3 py-1.5 rounded-lg border border-white/20 flex items-center gap-2">
                    <i class="fa-solid fa-phone text-[9px] text-blue-300"></i>
                    <span class="text-xs font-bold">${p}</span>
                </a>
            `).join('');
        }

        function renderList(list) {
            const grid = document.getElementById('listingGrid');
            grid.innerHTML = '';
            if(!list.length) { document.getElementById('emptyView').classList.remove('hidden'); return; }
            document.getElementById('emptyView').classList.add('hidden');

            list.forEach(item => {
                const imgs = (item.images_array && item.images_array.length > 0) ? item.images_array : (item.image_data ? [item.image_data] : []);
                const card = document.createElement('div');
                card.className = "bg-white rounded-2xl overflow-hidden border border-slate-100 flex flex-col relative shadow-sm";
                
                let adminControls = isAdmin ? `
                    <div class="absolute top-2 right-2 flex gap-1 z-20">
                        <button onclick="editItem(${item.id})" class="w-7 h-7 bg-white/90 text-blue-600 rounded-lg flex items-center justify-center shadow-sm"><i class="fa-solid fa-pen text-xs"></i></button>
                        <button onclick="sendToMultiTelegram(${item.id})" class="w-7 h-7 bg-blue-600 text-white rounded-lg flex items-center justify-center shadow-sm"><i class="fa-brands fa-telegram text-xs"></i></button>
                        <button onclick="deleteItem(${item.id})" class="w-7 h-7 bg-red-500 text-white rounded-lg flex items-center justify-center shadow-sm"><i class="fa-solid fa-trash-can text-xs"></i></button>
                    </div>
                    <div class="absolute top-2 left-2 z-20">
                         <input type="checkbox" class="select-checkbox item-checkbox" data-id="${item.id}" onchange="toggleItemSelect(${item.id})" ${selectedIds.has(item.id) ? 'checked' : ''}>
                    </div>
                ` : '';

                const phonesHtml = (bannerData.phones || []).map(p => `
                    <a href="tel:${p}" class="card-phone-link text-[10px] px-2 py-1.5"><i class="fa-solid fa-phone text-blue-500"></i> ${p}</a>
                `).join('');

                const ownerPhoneHtml = isAdmin && item.owner_phone ? `
                    <div class="mt-2 p-2 bg-blue-50 rounded-lg border border-blue-100">
                        <p class="text-[9px] font-bold text-blue-500 uppercase">Egasi:</p>
                        <a href="tel:${item.owner_phone}" class="text-xs font-bold text-blue-800">${item.owner_phone}</a>
                    </div>
                ` : '';

                card.innerHTML = `
                    <div class="slider-container">
                        <div class="slider-track" id="track-${item.id}" data-index="0">
                            ${imgs.length > 0 ? imgs.map((img, i) => `
                                <div class="slide-item">
                                    <img src="${img}" loading="${i === 0 ? 'eager' : 'lazy'}">
                                </div>`).join('') : '<div class="slide-item text-slate-300">Rasm yo\'q</div>'}
                        </div>
                        ${imgs.length > 1 ? `
                            <button onclick="moveSlider(${item.id}, -1)" class="slider-btn left-2"><i class="fa-solid fa-chevron-left text-[10px]"></i></button>
                            <button onclick="moveSlider(${item.id}, 1)" class="slider-btn right-2"><i class="fa-solid fa-chevron-right text-[10px]"></i></button>
                            <div class="slider-dots" id="dots-${item.id}">${imgs.map((_, i) => `<div class="dot ${i===0?'active':''}"></div>`).join('')}</div>
                        ` : ''}
                        <div class="absolute bottom-2 left-2 bg-blue-600 text-white px-2 py-0.5 rounded-md text-[9px] font-bold uppercase z-10">${item.type}</div>
                        ${adminControls}
                    </div>
                    <div class="p-3 flex flex-col flex-1">
                        <div class="flex justify-between items-center mb-1">
                            <h3 class="text-lg font-black text-slate-800">$${Number(item.price).toLocaleString()}</h3>
                            <span class="text-[9px] font-bold bg-slate-100 px-1.5 py-0.5 rounded text-slate-500">${item.category}</span>
                        </div>
                        <p class="text-slate-500 text-xs font-semibold mb-2">
                           ${item.rooms} xona
                        </p>
                        <p class="text-slate-400 text-[10px] line-clamp-2 mb-2 italic">${item.description || '...'}</p>
                        ${ownerPhoneHtml}
                        <div class="mt-auto pt-2 border-t border-slate-50">
                            <div class="flex flex-wrap gap-1 justify-center">${phonesHtml}</div>
                        </div>
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        // IMAGE COMPRESSION
        async function compressImage(base64Str, maxWidth = 800) {
            return new Promise((resolve) => {
                const img = new Image();
                img.src = base64Str;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;
                    if (width > maxWidth) {
                        height = (height * maxWidth) / width;
                        width = maxWidth;
                    }
                    canvas.width = width; canvas.height = height;
                    canvas.getContext('2d').drawImage(img, 0, 0, width, height);
                    resolve(canvas.toDataURL('image/jpeg', 0.8));
                };
            });
        }

        async function handleFiles(e) {
            const files = Array.from(e.target.files).slice(0, 10);
            showToast("Rasmlar yuklanmoqda...");
            for (const file of files) {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                await new Promise(r => {
                    reader.onload = async (ev) => {
                        const compressed = await compressImage(ev.target.result);
                        currentImages.push(compressed);
                        renderImagePreviews();
                        r();
                    };
                });
            }
        }

        async function saveItem() {
            const id = document.getElementById('editId').value;
            const btn = document.getElementById('saveBtn');
            btn.disabled = true;
            document.getElementById('saveBtnText').innerText = "SAQLANMOQDA...";

            const payload = {
                type: document.getElementById('propType').value,
                category: document.getElementById('propCat').value,
                price: document.getElementById('propPrice').value,
                rooms: document.getElementById('propRooms').value,
                description: document.getElementById('propDesc').value,
                owner_phone: document.getElementById('propOwnerPhone').value,
                image_data: currentImages.length > 0 ? currentImages[0] : null,
                images_array: currentImages.length > 0 ? currentImages : [] 
            };

            try {
                const { error } = id ? await sb.from('properties').update(payload).eq('id', id) : await sb.from('properties').insert([payload]);
                if (error) throw error;
                showToast("Muvaffaqiyatli saqlandi!");
                closeModal('propModal');
                fetchData();
            } catch (err) { 
                console.error(err);
                showToast("Xatolik! SQL bazani tekshiring."); 
            } finally {
                btn.disabled = false;
                document.getElementById('saveBtnText').innerText = "SAQLASH";
            }
        }

        async function sendToMultiTelegram(id, notify = true) {
            const item = properties.find(p => p.id === id);
            const imgs = item.images_array || (item.image_data ? [item.image_data] : []);
            const phones = (bannerData.phones || []).join(', ');
            const caption = `ðŸ  *E'lon:* ${item.category.toUpperCase()}\nðŸ’° *Narxi:* $${Number(item.price).toLocaleString()}\nðŸ“ *Turi:* ${item.type.toUpperCase()}\nðŸšª *Xonalar:* ${item.rooms}\nðŸ“ž *Aloqa:* ${phones}\n\nðŸ’¬ *Tavsif:* ${item.description || '-'}`;

            if(!tgTargets.length) {
                const { data } = await sb.from('telegram_targets').select('*');
                tgTargets = data || [];
            }
            if(!tgTargets.length) return;

            for (const t of tgTargets) {
                try {
                    if (imgs.length === 1) {
                        const blob = await (await fetch(imgs[0])).blob();
                        const fd = new FormData();
                        fd.append('chat_id', t.target_id);
                        fd.append('photo', blob, '1.jpg');
                        fd.append('caption', caption);
                        fd.append('parse_mode', 'Markdown');
                        await fetch(`https://api.telegram.org/bot${TG_TOKEN}/sendPhoto`, { method: 'POST', body: fd });
                    } else if (imgs.length > 1) {
                        const fd = new FormData();
                        fd.append('chat_id', t.target_id);
                        const media = [];
                        for (let i = 0; i < imgs.length; i++) {
                            const blob = await (await fetch(imgs[i])).blob();
                            fd.append(`file${i}`, blob, `${i}.jpg`);
                            media.push({
                                type: 'photo',
                                media: `attach://file${i}`,
                                caption: i === 0 ? caption : '',
                                parse_mode: 'Markdown'
                            });
                        }
                        fd.append('media', JSON.stringify(media));
                        await fetch(`https://api.telegram.org/bot${TG_TOKEN}/sendMediaGroup`, { method: 'POST', body: fd });
                    } else {
                        await fetch(`https://api.telegram.org/bot${TG_TOKEN}/sendMessage`, { 
                            method: 'POST', headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ chat_id: t.target_id, text: caption, parse_mode: 'Markdown' })
                        });
                    }
                } catch(e) { console.error("TG Error:", e); }
            }
            if(notify) showToast("Telegramga albom yuborildi!");
        }

        async function sendSelectedToTg() {
            if (selectedIds.size === 0) return showToast("E'lonlarni tanlang!");
            const ids = Array.from(selectedIds);
            showToast(`${ids.length}ta e'lon albom qilib yuborilmoqda...`);
            for (const id of ids) { await sendToMultiTelegram(id, false); }
            selectedIds.clear();
            document.getElementById('selectAll').checked = false;
            fetchData();
            showToast("Barcha tanlanganlar yuborildi!");
        }

        function moveSlider(propId, dir) {
            const track = document.getElementById(`track-${propId}`);
            const dots = document.querySelectorAll(`#dots-${propId} .dot`);
            if(!track) return;
            const total = track.children.length;
            let current = parseInt(track.dataset.index || 0);
            current = (current + dir + total) % total;
            track.style.transform = `translateX(-${current * 100}%)`;
            track.dataset.index = current;
            dots.forEach((dot, i) => i === current ? dot.classList.add('active') : dot.classList.remove('active'));
        }

        function renderImagePreviews() {
            const list = document.getElementById('imgPreviewList');
            list.innerHTML = currentImages.map((img, idx) => `
                <div class="relative aspect-square rounded-xl overflow-hidden border border-slate-200">
                    <img src="${img}" class="w-full h-full object-cover">
                    <button onclick="removeImg(${idx})" class="absolute top-1 right-1 bg-red-500 text-white w-5 h-5 rounded-full text-[10px]">Ã—</button>
                </div>
            `).join('');
        }
        function removeImg(idx) { currentImages.splice(idx, 1); renderImagePreviews(); }
        function openModal(id) { document.getElementById(id).classList.remove('hidden'); }
        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
        function showToast(msg) {
            const t = document.getElementById('toast');
            document.getElementById('toastMsg').innerText = msg;
            t.style.opacity = '1'; setTimeout(() => t.style.opacity = '0', 3000);
        }
        function handleAuth() {
            if(isAdmin) { if(confirm("Admin paneldan chiqasizmi?")) { localStorage.removeItem('makler_admin'); location.reload(); } }
            else openModal('authModal');
        }
        function doLogin() {
            if(document.getElementById('adminPass').value === '123') { localStorage.setItem('makler_admin', 'true'); location.reload(); }
            else showToast("Parol noto'g'ri!");
        }
        function updateUI() {
            document.getElementById('authBtn').innerHTML = '<i class="fa-solid fa-user-gear"></i> Chiqish';
            document.querySelectorAll('#fabBtn, #tgBtn, #contactMgrBtn, #adminToolbar').forEach(el => el.classList.remove('hidden'));
            document.getElementById('filterBar').classList.add('top-[118px]');
        }
        function openAddModal() { 
            document.getElementById('editId').value = ""; 
            document.getElementById('propOwnerPhone').value = "";
            document.getElementById('propDesc').value = "";
            document.getElementById('propPrice').value = "";
            document.getElementById('propRooms').value = "";
            currentImages = []; renderImagePreviews(); openModal('propModal'); 
        }
        function editItem(id) {
            const item = properties.find(p => p.id === id);
            document.getElementById('editId').value = item.id;
            document.getElementById('propType').value = item.type;
            document.getElementById('propCat').value = item.category;
            document.getElementById('propPrice').value = item.price;
            document.getElementById('propRooms').value = item.rooms;
            document.getElementById('propDesc').value = item.description;
            document.getElementById('propOwnerPhone').value = item.owner_phone || "";
            currentImages = item.images_array || [item.image_data];
            renderImagePreviews(); openModal('propModal');
        }
        async function deleteItem(id) { if(confirm("Ushbu e'lonni o'chirasizmi?")) { await sb.from('properties').delete().eq('id', id); fetchData(); } }
        function filterItems(type, btn) {
            document.querySelectorAll('.filter-btn').forEach(b => b.className = "filter-btn bg-white border border-slate-200 px-5 py-2 rounded-xl text-xs font-bold");
            btn.className = "filter-btn active bg-blue-600 text-white px-5 py-2 rounded-xl text-xs font-bold shadow-md";
            renderList(type === 'all' ? properties : properties.filter(p => p.type === type));
        }
        function toggleItemSelect(id) { if (selectedIds.has(id)) selectedIds.delete(id); else selectedIds.add(id); }
        function toggleSelectAll() {
            const isChecked = document.getElementById('selectAll').checked;
            document.querySelectorAll('.item-checkbox').forEach(cb => {
                const id = parseInt(cb.dataset.id);
                cb.checked = isChecked;
                if (isChecked) selectedIds.add(id); else selectedIds.delete(id);
            });
        }
        function openContactManager() {
            document.getElementById('mgrBannerTitle').value = bannerData.title || "";
            document.getElementById('mgrBannerText').value = bannerData.text || "";
            renderMgrPhoneList(); openModal('contactModal');
        }
        function renderMgrPhoneList() {
            document.getElementById('mgrPhoneList').innerHTML = (bannerData.phones || []).map((p, idx) => `
                <div class="flex items-center justify-between p-3 bg-slate-50 border rounded-xl">
                    <span class="text-sm font-bold">${p}</span>
                    <button onclick="removeContactPhone(${idx})" class="text-red-500"><i class="fa-solid fa-trash-can"></i></button>
                </div>
            `).join('');
        }
        function addContactPhone() {
            const val = document.getElementById('newContactPhone').value.trim();
            if(val) { bannerData.phones = bannerData.phones || []; bannerData.phones.push(val); document.getElementById('newContactPhone').value = ""; renderMgrPhoneList(); }
        }
        function removeContactPhone(idx) { bannerData.phones.splice(idx, 1); renderMgrPhoneList(); }
        async function saveBannerSettings() {
            bannerData.title = document.getElementById('mgrBannerTitle').value;
            bannerData.text = document.getElementById('mgrBannerText').value;
            await sb.from('settings').upsert({ key: 'contact_banner', value: bannerData });
            renderBanner(); fetchData(); closeModal('contactModal');
        }
        function renderTargetList() {
            document.getElementById('targetList').innerHTML = tgTargets.map(t => `
                <div class="flex items-center justify-between p-3 bg-white border rounded-xl mb-2">
                    <span class="text-xs font-bold">${t.target_id}</span>
                    <button onclick="removeTarget(${t.id})" class="text-red-500 p-2"><i class="fa-solid fa-trash-can"></i></button>
                </div>
            `).join('');
        }
        async function addTarget() {
            const val = document.getElementById('newTgTarget').value.trim();
            if(!val) return;
            try {
                await sb.from('telegram_targets').insert([{ target_id: val }]);
                document.getElementById('newTgTarget').value = '';
                await fetchTgTargets();
            } catch (err) {}
        }
        async function removeTarget(id) {
            await sb.from('telegram_targets').delete().eq('id', id);
            await fetchTgTargets();
        }
        function openTgManager() { fetchTgTargets(); openModal('tgModal'); }
    </script>
</body>
</html>
